<!--
  Rui Santos
  Complete project details at https://RandomNerdTutorials.com/esp32-web-bluetooth/

  Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files.
  The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->

<!DOCTYPE html>
<html>
<head>
    <title>NTGS Goniómetro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="favicon.ico">
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="UTF-8">
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="theme-color" content="#0A1128">

</head>
<body>
    <div class="topnav">
        <h1>NTGS Goniómetro</h1>
    </div>
    <div class="content">
        
        <div class="card-grid">
            <div class="card">
                <h2>Elevation:</h2>
                <p class="reading"><span id="valueContainer">XXXX.XX</span></p>
                <p class="gray-label">Última lectura: <span id="timestamp"></span></p>
            </div>
            <div class="card">
                <h2>Y Axis (Pitch):</h2>
                <p class="reading"><span id="valueContainerY">YYYY.YY</span></p>
                <p class="gray-label">Última lectura: <span id="timestampY"></span></p>
            </div>
            <!-- <div class="card">
                <h2>Control GPIO 2</h2>
                <button id="onButton" class="onButton">ON</button>
                <button id="offButton" class="offButton">OFF</button>
                <p class="gray-label">Last value sent: <span id="valueSent"></span></p>
            </div> -->
        </div>
        <div class="card-grid">
            <div class="card">
                <p>
                    <button id="connectBleButton" class="connectButton"> Connect to BLE Device</button>
                    <button id="disconnectBleButton" class="disconnectButton"> Disconnect BLE Device</button>
                </p>
                <p class="gray-label">BLE state: <strong><span id="bleState" style="color:#d13a30;">Disconnected</span></strong></p>
            </div>
        </div>
    </div>
    <!-- <div class="footer">
        <p><a href="https://randomnerdtutorials.com/">Created by RandomNerdTutorials.com</a></p>
        <p><a href="https://RandomNerdTutorials.com/esp32-web-bluetooth/">Read the full project here.</a></p>
    </div> -->
</body>
<script>
  // PWA: registrar Service Worker (si existe el archivo)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
  }

  // DOM Elements
  const connectButton = document.getElementById("connectBleButton");
  const disconnectButton = document.getElementById("disconnectBleButton");

  // Estos elementos existen en tu HTML
  const retrievedValue = document.getElementById("valueContainer");
  const retrievedValueY = document.getElementById("valueContainerY");
  const bleStateContainer = document.getElementById("bleState");
  const timestampContainer = document.getElementById("timestamp");
  const timestampContainerY = document.getElementById("timestampY");

  // Estos NO existen ahora mismo (están comentados en el HTML), así que los dejamos opcionales
  const onButton = document.getElementById("onButton");
  const offButton = document.getElementById("offButton");
  const latestValueSent = document.getElementById("valueSent");

  // Define BLE Device Specs
  const deviceName = "ESP32";

  // Servicio principal (el tuyo)
  const bleService = "19b10000-e8f2-537e-4f6c-d104768a1214";

  // Characteristics
  const ledCharacteristic = "19b10002-e8f2-537e-4f6c-d104768a1214";     // opcional
  const sensorCharacteristic = "19b10001-e8f2-537e-4f6c-d104768a1214";  // Elevation
  const eje_Y_Characteristic = "96165373-4590-46ce-86a8-a5d3fd07eeb9";  // Y Axis

  // Global BLE variables
  let bleDevice = null;
  let bleServer = null;
  let bleServiceFound = null;

  let sensorCharacteristicFound = null;
  let eje_Y_CharacteristicFound = null;

  console.log("Versión (script completo) OK");

  // Eventos
  connectButton.addEventListener("click", () => {
    if (isWebBluetoothEnabled()) {
      connectToDevice();
    }
  });

  disconnectButton.addEventListener("click", disconnectDevice);

  // Botones opcionales (si existen en el HTML)
  if (onButton) onButton.addEventListener("click", () => writeOnCharacteristic(1));
  if (offButton) offButton.addEventListener("click", () => writeOnCharacteristic(0));

  function isWebBluetoothEnabled() {
    if (!navigator.bluetooth) {
      console.log("Web Bluetooth API is not available in this browser!");
      bleStateContainer.innerHTML = "Web Bluetooth API is not available in this browser/device!";
      return false;
    }
    console.log("Web Bluetooth API supported in this browser.");
    return true;
  }

  async function connectToDevice() {
    try {
      console.log("Initializing Bluetooth...");

      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: deviceName }],
        optionalServices: [bleService]
      });

      console.log("Device Selected:", bleDevice.name);

      bleStateContainer.innerHTML = "Connected to device " + bleDevice.name;
      bleStateContainer.style.color = "#24af37";

      bleDevice.addEventListener("gattservicedisconnected", onDisconnected);

      bleServer = await bleDevice.gatt.connect();
      console.log("Connected to GATT Server");

      bleServiceFound = await bleServer.getPrimaryService(bleService);
      console.log("Service discovered:", bleServiceFound.uuid);

      // 1) Elevation characteristic: notificaciones + lectura inicial
      sensorCharacteristicFound = await bleServiceFound.getCharacteristic(sensorCharacteristic);
      console.log("Elevation characteristic:", sensorCharacteristicFound.uuid);

      sensorCharacteristicFound.addEventListener("characteristicvaluechanged", handleCharacteristicChange);
      await sensorCharacteristicFound.startNotifications();
      console.log("Elevation notifications started.");

      const value = await sensorCharacteristicFound.readValue();
      retrievedValue.innerHTML = new TextDecoder().decode(value);

      // 2) Y Axis characteristic: notificaciones + lectura inicial
      eje_Y_CharacteristicFound = await bleServiceFound.getCharacteristic(eje_Y_Characteristic);
      console.log("Y Axis characteristic:", eje_Y_CharacteristicFound.uuid);
      //console.log("Y Axis properties:", eje_Y_CharacteristicFound.properties);

      eje_Y_CharacteristicFound.addEventListener("characteristicvaluechanged", handleCharacteristicChangeY);
      await eje_Y_CharacteristicFound.startNotifications();
      console.log("Y Axis notifications started.");

      const valueY = await eje_Y_CharacteristicFound.readValue();
      retrievedValueY.innerHTML = new TextDecoder().decode(valueY);

    } catch (error) {
      console.log("Error:", error);
      bleStateContainer.innerHTML = "Error connecting";
      bleStateContainer.style.color = "#d13a30";
    }
  }

  function onDisconnected(event) {
    console.log("Device Disconnected:", event.target?.device?.name);
    bleStateContainer.innerHTML = "Device disconnected";
    bleStateContainer.style.color = "#d13a30";

    // Si quieres autoreconectar, descomenta:
    // connectToDevice();
  }

  function handleCharacteristicChange(event) {
    const newValueReceived = new TextDecoder().decode(event.target.value);
    //console.log("Elevation changed:", newValueReceived);
    retrievedValue.innerHTML = newValueReceived;
    timestampContainer.innerHTML = getDateTime();
  }

  function handleCharacteristicChangeY(event) {
    const newValueReceived = new TextDecoder().decode(event.target.value);
    //console.log("Y Axis changed:", newValueReceived);
    retrievedValueY.innerHTML = newValueReceived;
    timestampContainerY.innerHTML = getDateTime();
  }

  async function writeOnCharacteristic(value) {
    try {
      if (!bleServer || !bleServer.connected || !bleServiceFound) {
        console.error("Bluetooth is not connected. Cannot write to characteristic.");
        window.alert("Bluetooth is not connected. Cannot write to characteristic.\nConnect to BLE first!");
        return;
      }

      const characteristic = await bleServiceFound.getCharacteristic(ledCharacteristic);
      console.log("Found LED characteristic:", characteristic.uuid);

      const data = new Uint8Array([value]);
      await characteristic.writeValue(data);

      if (latestValueSent) latestValueSent.innerHTML = value;
      console.log("Value written:", value);

    } catch (error) {
      console.error("Error writing to LED characteristic:", error);
    }
  }

  async function disconnectDevice() {
    console.log("Disconnect Device.");

    try {
      if (!bleServer || !bleServer.connected) {
        console.error("Bluetooth is not connected.");
        window.alert("Bluetooth is not connected.");
        return;
      }

      // Parar notificaciones (si existen)
      if (sensorCharacteristicFound) {
        await sensorCharacteristicFound.stopNotifications();
        console.log("Elevation notifications stopped");
      }

      if (eje_Y_CharacteristicFound) {
        await eje_Y_CharacteristicFound.stopNotifications();
        console.log("Y Axis notifications stopped");
      }

      bleServer.disconnect();
      console.log("Device Disconnected");

      bleStateContainer.innerHTML = "Device Disconnected";
      bleStateContainer.style.color = "#d13a30";

    } catch (error) {
      console.log("An error occurred:", error);
    }
  }

  function getDateTime() {
    const currentdate = new Date();
    const day = ("00" + currentdate.getDate()).slice(-2);
    const month = ("00" + (currentdate.getMonth() + 1)).slice(-2);
    const year = currentdate.getFullYear();
    const hours = ("00" + currentdate.getHours()).slice(-2);
    const minutes = ("00" + currentdate.getMinutes()).slice(-2);
    const seconds = ("00" + currentdate.getSeconds()).slice(-2);
    return `${day}/${month}/${year} at ${hours}:${minutes}:${seconds}`;
  }
</script>


</html>